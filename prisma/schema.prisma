// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}


datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// üß© MODELO DE SEGURIDAD Y GOBERNANZA ISO 27001
//

// =========================
// üßë‚Äçüíª USUARIOS Y ROLES
// =========================

model Usuario {
  id             Int             @id @default(autoincrement())
  nombre         String
  email          String          @unique
  password       String          // Hash seguro (bcrypt)
  estado         EstadoUsuario   @default(ACTIVO)
  rolId          Int
  rol            Rol             @relation(fields: [rolId], references: [id])
  creadoEn       DateTime        @default(now())
  actualizadoEn  DateTime        @updatedAt
  bitacoras      Bitacora[]

  @@map("usuarios")
}

model Rol {
  id             Int             @id @default(autoincrement())
  nombre         String           @unique
  descripcion    String?
  estado         EstadoGeneral    @default(ACTIVO)
  usuarios       Usuario[]
  permisos       RolPermiso[]
  creadoEn       DateTime         @default(now())
  actualizadoEn  DateTime         @updatedAt

  @@map("roles")
}

// =========================
// üß© M√ìDULOS Y PERMISOS
// =========================

model Modulo {
  id             Int             @id @default(autoincrement())
  nombre         String           @unique
  descripcion    String?
  estado         EstadoGeneral    @default(ACTIVO)
  permisos       Permiso[]
  creadoEn       DateTime         @default(now())
  actualizadoEn  DateTime         @updatedAt

  @@map("modulos")
}

model Permiso {
  id             Int              @id @default(autoincrement())
  moduloId       Int
  modulo         Modulo           @relation(fields: [moduloId], references: [id])
  puedeCrear     Boolean           @default(false)
  puedeLeer      Boolean           @default(false)
  puedeEditar    Boolean           @default(false)
  puedeEliminar  Boolean           @default(false)
  estado         EstadoGeneral     @default(ACTIVO)
  roles          RolPermiso[]
  creadoEn       DateTime          @default(now())
  actualizadoEn  DateTime          @updatedAt
  descripcion    String? 
  @@map("permisos")
}

model RolPermiso {
  id             Int              @id @default(autoincrement())
  rolId          Int
  permisoId      Int
  rol            Rol              @relation(fields: [rolId], references: [id])
  permiso        Permiso          @relation(fields: [permisoId], references: [id])
  estado         EstadoGeneral     @default(ACTIVO)
  creadoEn       DateTime          @default(now())
  actualizadoEn  DateTime          @updatedAt
  descripcion    String? 
  @@unique([rolId, permisoId])
  @@map("roles_permisos")
}

// =========================
// üßæ BIT√ÅCORA (AUDITOR√çA)
// =========================

model Bitacora {
  id            Int        @id @default(autoincrement())
  usuarioId     Int
  accion        String
  modulo        String
  descripcion   String?
  fecha         DateTime   @default(now())
  usuario       Usuario    @relation(fields: [usuarioId], references: [id])

  @@map("bitacora")
}

// =========================
// üß† ENUMS DE ESTADO
// =========================

enum EstadoUsuario {
  ACTIVO
  SUSPENDIDO
  ELIMINADO
}

enum EstadoGeneral {
  ACTIVO
  INACTIVO
  ELIMINADO
}

model EnteDeduccion {
  id             Int                     @id @default(autoincrement())
  nombre         String                  @unique         // IHSS, RAP, ISR, INJUPEMP, IMPREMA
  descripcion    String?
  estado         EstadoGeneral           @default(ACTIVO)
  creadoEn       DateTime                @default(now())
  actualizadoEn  DateTime                @updatedAt

  configuraciones ConfiguracionDeduccion[]
  @@map("ente_deducciones")
}

model ConfiguracionDeduccion {
  id             Int              @id @default(autoincrement())
  enteId         Int
  ente           EnteDeduccion    @relation(fields: [enteId], references: [id])

  anio           Int
  tipo           TipoDeduccion    // PORCENTAJE, TECHO, MONTO_FIJO
  subTipo        String?          // TRABAJADOR, EMPLEADOR, FONDO_RESERVA
  porcentaje     Decimal?         @db.Decimal(10,4)
  montoFijo      Decimal?         @db.Decimal(12,2)
  techo          Decimal?         @db.Decimal(12,2)

  estado         EstadoGeneral    @default(ACTIVO)
  descripcion    String?
  creadoEn       DateTime         @default(now())
  actualizadoEn  DateTime         @updatedAt

  @@map("configuraciones_deducciones")
}

model TramoISR {
  id             Int             @id @default(autoincrement())
  anio           Int
  desde          Decimal         @db.Decimal(12,2)
  hasta          Decimal?        @db.Decimal(12,2)     // null = en adelante
  porcentaje     Decimal         @db.Decimal(10,4)

  estado         EstadoGeneral   @default(ACTIVO)
  creadoEn       DateTime        @default(now())
  actualizadoEn  DateTime        @updatedAt

  @@map("tramos_isr")
}

model RegimenLaboral {
  id              Int            @id @default(autoincrement())
  nombre          String         @unique      // PRIVADO, PUBLICO, DOCENTE
  aplicaIHSS      Boolean        @default(false)
  aplicaRAP       Boolean        @default(false)
  aplicaISR       Boolean        @default(true)
  aplicaINJUPEMP  Boolean        @default(false)
  aplicaIMPREMA   Boolean        @default(false)

  estado          EstadoGeneral  @default(ACTIVO)
  creadoEn        DateTime       @default(now())
  actualizadoEn   DateTime       @updatedAt
  cotizaciones      Cotizacion[]

  @@map("regimenes_laborales")
}

model Cotizacion {
  id                 Int           @id @default(autoincrement())
  empleadoNombre     String
  salarioBruto       Decimal       @db.Decimal(12,2)
  regimenId          Int?
  regimen            RegimenLaboral? @relation(fields: [regimenId], references: [id])

  totalDeducciones   Decimal?      @db.Decimal(12,2)
  salarioNeto        Decimal?      @db.Decimal(12,2)

  creadoEn           DateTime      @default(now())
  actualizadoEn      DateTime      @updatedAt

  @@map("cotizaciones")
}


enum TipoDeduccion {
  PORCENTAJE
  TECHO
  MONTO_FIJO
}
